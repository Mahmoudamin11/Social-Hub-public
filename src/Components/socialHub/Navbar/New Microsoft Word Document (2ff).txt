import { useState, useCallback, useEffect, useMemo } from "react";
import axios from "axios";
import Cookies from "js-cookie";
import { API } from "../Api/Api";
import { showToast } from "../Utils/showToast";
import { io } from "socket.io-client";

const NotificationsHook = () => {
  const userId = Cookies.get("userID");

  const [notifications, setNotifications] = useState([]);
  const [unreadNotifications, setUnreadNotifications] = useState([]);
  const [readNotifications, setReadNotifications] = useState([]);
  const [loadingGeneral, setLoadingGeneral] = useState(false);
  const [loadingNotifications, setloadingNotifications] = useState(false);

  // Initialize Socket.IO
  const socket = useMemo(() => io("http://localhost:5000"), []);

  const apiUrls = useMemo(
    () => ({
      fetchNotifications: `${API.getNotifications10By10}/${userId}`,
      fetchUnreadNotifications: `${API.getNotificationsNotReaded}/${userId}`,
      markAllAsRead: `${API.markIsReadNotifications}/${userId}`,
    }),
    [userId]
  );

  const fetchData = async (url, setState, setLoading) => {
    setLoading(true);
    try {
      const response = await axios.get(url);
      setState(response.data);
    } catch (error) {
      console.error(`Error fetching`, error);
      showToast("Error", error.response?.message || "Failed to fetch data");
    } finally {
      setLoading(false);
    }
  };

  const fetchNotifications = useCallback(() => {
    fetchData(
      apiUrls.fetchNotifications,
      setNotifications,
      setloadingNotifications
    );
  }, [apiUrls]);

  const fetchUnreadNotifications = useCallback(() => {
    fetchData(
      apiUrls.fetchUnreadNotifications,
      setUnreadNotifications,
      setLoadingGeneral
    );
  }, [apiUrls]);

  const markAllAsRead = useCallback(async () => {
    await fetchData(
      apiUrls.markAllAsRead,
      setReadNotifications,
      setLoadingGeneral
    );
  }, [apiUrls]);

  useEffect(() => {
    // Listen for real-time notifications
    socket.on("new-notification", (notification) => {
      console.log("Real-time notification received:", notification);
      setUnreadNotifications((prev) => [...prev, notification]);
    });

    return () => {
      socket.disconnect();
    };
  }, [socket]);

  return {
    notifications,
    unreadNotifications,
    loadingGeneral,
    loadingNotifications,
    fetchNotifications,
    fetchUnreadNotifications,
    markAllAsRead,
    socket, // Provide socket instance for external usage
  };
};

export default NotificationsHook;
